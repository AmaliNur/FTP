Основные изменения и дополнения:

Список клиентских потоков: client_threads используется для отслеживания всех запущенных клиентских потоков.
Ожидание завершения всех клиентских потоков: После выхода из основного цикла сервер ожидает завершения всех клиентских потоков с помощью join().
Обработка исключений при принятии соединений: Добавлено управление исключениями при принятии соединений для предотвращения аварийного завершения работы сервера.
Теперь сервер корректно остановится при получении команды stop.